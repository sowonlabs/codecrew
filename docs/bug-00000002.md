# Bug #00000002: Claude CLI v2.0 Breaking Changes

## 기본 정보
- **ID**: bug-00000002
- **우선순위**: 긴급
- **상태**: resolved
- **작성자**: GitHub Copilot
- **작업자**: dohapark
- **생성일**: 2025-10-03 19:15:00
- **수정일**: 2025-10-03 19:45:00

## 현상

### Slack Bot 실패
Slack Bot에서 Claude 에이전트를 호출하면 빈 응답만 반환되고 즉시 실패합니다.

**에러 로그:**
```
[Nest] 60819  - 10/03/2025, 7:15:05 PM     LOG [ClaudeProvider] Executing claude with prompt (length: 3732)
🔧 DEBUG: Response content type: string
🔧 DEBUG: Response content (first 500 chars): 
[빈 응답]
[Nest] 60819  - 10/03/2025, 7:15:05 PM   DEBUG [TaskManagementService] Added log to task task_1759486504978_vmooovzaz: [INFO] Query completed. Success: false
[Nest] 60819  - 10/03/2025, 7:15:05 PM     LOG [TaskManagementService] Task task_1759486504978_vmooovzaz failed in 140ms
```

### 증상
- Claude CLI 실행 시 빈 응답
- 140ms 만에 즉시 실패 (정상 응답 시간보다 훨씬 짧음)
- 모든 Claude 관련 query/execute 명령어 작동 불가
- Slack, CLI, MCP 모든 인터페이스에서 동일한 문제 발생

## 환경
- **OS**: macOS
- **Claude CLI**: v2.0.5 (업그레이드: 2025-10-03 13:45)
- **CodeCrew**: v0.3.5
- **Node.js**: v20.19.2
- **설치 경로**: `/Users/doha/.nvm/versions/node/v20.19.2/bin/claude`

## 원인

### Timeline
| 날짜 | 이벤트 |
|------|--------|
| 2025-09-29 14:41 | Claude CLI v2.0.0 릴리즈 (MAJOR VERSION) |
| 2025-10-02 16:20 | Claude CLI v2.0.5 릴리즈 |
| 2025-10-03 13:45 | 사용자가 v2.0.5로 업그레이드 |
| 2025-10-03 19:15 | Slack Bot에서 버그 발견 (6시간 후) |

### Claude CLI v2.0 Breaking Changes

#### 1. `-p` 플래그 의미 변경 (CRITICAL!)

**Before (v1.x):**
```bash
claude -p "Your prompt text here"
# -p 다음에 프롬프트 텍스트 전달
```

**After (v2.x):**
```bash
claude -p                    # --print mode (print and exit)
echo "prompt" | claude -p    # stdin으로 입력 받음
```

#### 2. 플래그 순서 의존성

**❌ 작동 안함:**
```bash
claude --output-format stream-json --verbose -p
# Error: When using --print, --output-format=stream-json requires --verbose
```

**✅ 작동:**
```bash
claude -p --verbose --output-format stream-json
# 올바른 순서: -p가 맨 앞, 그 다음 --verbose, 마지막에 --output-format
```

#### 3. `--verbose` 필수 요구사항

`--output-format=stream-json`을 사용하려면 **반드시 `--verbose` 플래그가 필요**합니다.

### 기존 코드의 문제

**파일:** `src/providers/claude.provider.ts`

```typescript
protected getDefaultArgs(): string[] {
  return ['--output-format', 'stream-json', '--verbose', '-p'];
}
```

**문제점:**
1. 플래그 순서가 잘못됨 (`-p`가 맨 뒤)
2. `--verbose`가 `--output-format`보다 뒤에 있음
3. v2.0에서 `-p`의 의미가 변경되었는데 v1.x 방식으로 사용

## 해결책

### 코드 수정

**파일:** `src/providers/claude.provider.ts`

```typescript
// 수정 전 (v1.x 호환)
protected getDefaultArgs(): string[] {
  return ['--output-format', 'stream-json', '--verbose', '-p'];
}

protected getExecuteArgs(): string[] {
  return ['--output-format', 'stream-json', '--verbose', '-p'];
}

// 수정 후 (v2.x 호환)
protected getDefaultArgs(): string[] {
  // Claude CLI v2.0+ requires -p first, then --verbose, then --output-format
  return ['-p', '--verbose', '--output-format', 'stream-json'];
}

protected getExecuteArgs(): string[] {
  // Claude CLI v2.0+ requires -p first, then --verbose, then --output-format
  return ['-p', '--verbose', '--output-format', 'stream-json'];
}
```

### 테스트

#### 1. 수동 CLI 테스트
```bash
# 잘못된 순서 (실패)
echo "Say hello" | claude --output-format stream-json --verbose -p
# 결과: Error: When using --print, --output-format=stream-json requires --verbose

# 올바른 순서 (성공)
echo "Say hello in Korean" | claude -p --verbose --output-format stream-json
# 결과: {"type":"assistant","message":{"content":[{"type":"text","text":"안녕하세요! 👋"}]}}
```

#### 2. CodeCrew CLI 테스트
```bash
node dist/main.js query "@claude Say hi in Korean" --raw
# 결과: 안녕하세요! 👋
```

#### 3. Slack Bot 테스트
```
@CodeCrew gugudan1.js 파일에 구구단 자바스크립트 프로그램을 작성해주세요
# 결과: 정상 응답 및 파일 생성
```

## 영향 범위

### 영향받는 컴포넌트
- ✅ **Claude Provider**: 수정 완료
- ✅ **Slack Bot**: Claude 에이전트 호출 정상화
- ✅ **CLI**: query/execute 명령어 정상화
- ✅ **MCP Server**: tool 호출 정상화

### 영향받지 않는 컴포넌트
- ✅ **Copilot Provider**: v0.0.330 (플래그 최소 사용)
- ✅ **Gemini Provider**: v0.6.1 (플래그 최소 사용)

## 예방책

### 1. 버전 핀닝
`package.json` 또는 문서에서 Claude CLI 버전 명시:
```bash
npm install -g @anthropic-ai/claude-code@2.0.5
```

### 2. 버전 감지
향후 v1.x와 v2.x를 동시 지원하려면 버전 감지 로직 추가:
```typescript
async detectClaudeVersion(): Promise<'v1' | 'v2'> {
  const version = await execSync('claude --version').toString();
  return version.startsWith('2.') ? 'v2' : 'v1';
}
```

### 3. CI/CD 테스트
다양한 Claude CLI 버전에 대한 integration test 추가

### 4. 마이그레이션 가이드
README에 Claude CLI v2.x 마이그레이션 안내 추가

## 관련 파일
- `src/providers/claude.provider.ts` - 수정된 파일
- `CLAUDE_V2_BREAKING_CHANGES.md` - 상세 breaking changes 문서
- `bug.md` - 버그 트래킹

## 교훈
메이저 버전 업데이트(v1 → v2)는 항상 breaking changes를 동반합니다.
CLI 도구의 업데이트 후에는 **반드시 integration test**를 실행해야 합니다.

## 참고 자료
- Claude CLI v2.0.0 Release: https://www.npmjs.com/package/@anthropic-ai/claude-code/v/2.0.0
- Claude CLI 공식 문서: https://claude.ai/download
- CodeCrew Issue: Slack Bot Claude integration failure

---

**Status**: ✅ Resolved  
**Next Action**: 사용자가 Slack Bot 재시작 후 최종 확인 → closed 상태로 전환
